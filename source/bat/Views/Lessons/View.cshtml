@model bat.logic.Models.Lessons.View
@{
    ViewBag.Title = "View Lesson";
}

@section head {
}
@section scripts {
}
<h2>Lesson Details</h2>

<p>
    Date: @Model.lesson.BookingDate.ToString("dd/MM/yyyy hh:mm tt")
</p>
<p>
    Duration mins: @Model.lesson.DurationMins
</p>
<p>
    Class size: @Model.lesson.ClassSize
</p>
<p>
    Description: @Model.lesson.Description
</p>



<button id="start" class="btn btn-success" onclick="startStream(sessionId, token)">Start Stream</button>
<button id="stop" class="btn btn-danger hidden" onclick="stopStream()">Stop Stream</button>

<div id="streamCon">
    <div id="streamBoxSelf" style="width:400px; height:300px"></div>
    <div id="streamBoxOther" style="width:400px; height:300px"></div>
</div>

<!-- TokBox API  -->
<script src="https://static.opentok.com/v2/js/opentok.min.js"></script>

<!-- Link to local TokBox script  -->
<script type="text/javascript" src="~/assets/js/videoStreaming.js"></script>

<script>
    //These are manually generated session id and token. Production requires Sessions and tokens be generated by server.
    var sessionId = "@Model.session";

    //Publisher Token
    var token = "@Model.token";

    var lessonId = "@Model.lesson.ID";
    var streamName = lessonId+"-@Model.host.ID";
    connect(sessionId);


    var streamConnect = false;

    session.on("streamCreated", function (event) {
        stream = event.stream;
        console.log("New stream in the session: " + stream.streamId);
        var streamName = stream.name;
        var streamNameArray = streamName.split('-');
        var streamLessonID = streamNameArray[0];

        // Debugging
        console.log(streamLessonID);

        if (streamLessonID == lessonId) {
            if (streamConnect === false) {
                session.subscribe(stream, streamBoxOther);
                streamConnect = true;
            } else {
                console.log("Already subscribed.");
            }
        } else {
            console.log("Not the lesson.")
        }
    });
</script>